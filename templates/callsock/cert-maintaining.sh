apt-get update && apt-get install -y certbot python3.12-venv less curl unzip openssl python3-pip && python3 -m venv prod-venv && source prod-venv/bin/activate && pip3 install certbot-dns-route53 && curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" && unzip -oq "awscliv2.zip" && ./aws/install --update && CERTS_DIR="/etc/letsencrypt" && S3_CERTS_PATH="s3://${CERTS_BUCKET_NAME}/certs/" && DOMAIN_CERT_PATH="${CERTS_DIR}/live/${DOMAIN}/cert.pem" && aws s3 sync "${S3_CERTS_PATH}" "${CERTS_DIR}" --exact-timestamps && if [[ -f "$DOMAIN_CERT_PATH" ]]; then echo "Certificate found locally, checking expiry..."; EXPIRY_DAYS=$(openssl x509 -enddate -noout -in "$DOMAIN_CERT_PATH" | cut -d= -f2 | date -d - +%s); CURRENT_DATE=$(date +%s); DAYS_LEFT=$(( (EXPIRY_DAYS - CURRENT_DATE) / 86400 )); if [[ $DAYS_LEFT -le 30 ]]; then echo "Certificate is expiring in $DAYS_LEFT days. Renewing..."; certbot renew ; aws s3 sync "${CERTS_DIR}" "${S3_CERTS_PATH}" else echo "Certificate is valid for $DAYS_LEFT days. Exiting.";  exit 0; fi; else echo "No certificate found. Generating a new one..."; certbot certonly --non-interactive --dns-route53 --agree-tos --register-unsafely-without-email -d "*.${DOMAIN}" -d "${DOMAIN}"; aws s3 sync "${CERTS_DIR}" "${S3_CERTS_PATH}" fi